function CAnimation(){this.transformationKeys=[],this.visibilityKeys=[],this.colorKeys=[],this.alphaKeys=[],this.verticesPositionKeys=[],this.verticesColorKeys=[]}function CAnimationPlayback(){this.keys=[],this.playing=!1,this.speed=1,this.repeat=!1,this.position=0}CAnimation.prototype.hasTransformationKeys=function(){return 0<this.transformationKeys.length},CAnimation.prototype.hasVisibilityKeys=function(){return 0<this.visibilityKeys.length},CAnimation.prototype.hasColorKeys=function(){return 0<this.colorKeys.length},CAnimation.prototype.hasAlphaKeys=function(){return 0<this.alphaKeys.length},CAnimation.prototype.hasVerticesPositionKeys=function(){return 0<this.verticesPositionKeys.length},CAnimation.prototype.hasVerticesColorKeys=function(){return 0<this.verticesColorKeys.length},CAnimation.prototype.addKeyFromString=function(e,t){if(void 0!==e){var i=JSON.parse(e);if(void 0!==i&&void 0!==i.type&&void 0!==i.frame&&void 0!==i.intp&&void 0!==i.data)if("step"==i.intp||"linear"==i.intp){var s={frame:i.frame,interpolation:i.intp};if("TRANS"==i.type){s.transform=mat4.create();for(var o=0;o<16;++o)s.transform[o]=i.data[o];this.transformationKeys.push(s)}else"COLOR"==i.type?(s.color=[i.data[0]/255,i.data[1]/255,i.data[2]/255],t<6&&correctOldObjectColors(s.color),this.colorKeys.push(s)):"ALPHA"==i.type?(s.alpha=i.data[0],this.alphaKeys.push(s)):"VISIB"==i.type?(s.visible=1==i.data[0],this.visibilityKeys.push(s)):"VTPOS"==i.type?(s.name=i.data[0],this.verticesPositionKeys.push(s)):"VTCLR"==i.type?(s.name=i.data[0],this.verticesColorKeys.push(s)):console.log("Unknown animation key type: "+i.type)}else console.log("Unknown animation key interpolation: "+i.intp);else console.log("Cannot parse animation key: "+e)}},CAnimation.prototype.setTransformationForFrame=function(e,t){if(void 0!==t&&void 0!==e&&void 0!==e.transform&&0!==this.transformationKeys.length){var i=mat4.clone(e.transform);if(t<=this.transformationKeys[0].frame)i=mat4.clone(this.transformationKeys[0].transform);else if(t>=this.transformationKeys[this.transformationKeys.length-1].frame)i=mat4.clone(this.transformationKeys[this.transformationKeys.length-1].transform);else{for(var s=0;this.transformationKeys[s].frame<t;)s++;var o,a,r,n,l=this.transformationKeys[s-1],y=this.transformationKeys[s],h=mat4.clone(l.transform),m=mat4.clone(y.transform);"step"==y.interpolation?i=t==y.frame?m:h:(r=(t-l.frame)/(y.frame-l.frame),n=mat3.create(),o=mat3.create(),mat3.fromMat4(n,h),mat3.fromMat4(o,m),a=quat.create(),y=quat.create(),l=quat.create(),quat.fromMat3(a,n),quat.fromMat3(y,o),quat.slerp(l,a,y,r),quat.normalize(l,l),n=vec3.create(),o=vec3.create(),a=vec3.create(),y=vec3.create(),vec3.lerp(n,e.boundingBox.minPos,e.boundingBox.maxPos,.5),vec3.transformMat4(o,n,h),vec3.transformMat4(a,n,m),vec3.lerp(y,o,a,r),r=vec3.create(),vec3.transformQuat(r,n,l),n=vec3.create(),vec3.subtract(n,y,r),mat4.fromRotationTranslation(i,l,n))}e.transform=i}},CAnimation.prototype.setVisibilityForFrame=function(e,t){if(void 0!==t&&void 0!==e&&void 0!==e.isVisible&&0!==this.visibilityKeys.length){mat4.clone(e.transform);if(t<=this.visibilityKeys[0].frame)e.isVisible=this.visibilityKeys[0].visible;else if(t>=this.visibilityKeys[this.visibilityKeys.length-1].frame)e.isVisible=this.visibilityKeys[this.visibilityKeys.length-1].visible;else{for(var i=0;this.visibilityKeys[i].frame<t;)i++;var s=this.visibilityKeys[i-1],o=this.visibilityKeys[i];e.isVisible=(t==o.frame?o:s).visible}}},CAnimation.prototype.setColorForFrame=function(e,t){if(void 0!==t&&void 0!==e&&void 0!==e.faceColor&&0!==this.colorKeys.length){var i=[0,0,0];if(t<=this.colorKeys[0].frame)i=this.colorKeys[0].color.slice();else if(t>=this.colorKeys[this.colorKeys.length-1].frame)i=this.colorKeys[this.colorKeys.length-1].color.slice();else{for(var s=0;this.colorKeys[s].frame<t;)s++;var o=this.colorKeys[s-1],a=this.colorKeys[s],r=o.color.slice(),n=a.color.slice();i="step"==a.interpolation?t==a.frame?n:r:(a=(t-o.frame)/(a.frame-o.frame),[r[0]*(o=1-a)+n[0]*a,r[1]*o+n[1]*a,r[2]*o+n[2]*a])}e.faceColor.RGB=i}},CAnimation.prototype.setAlphaForFrame=function(e,t){if(void 0!==t&&void 0!==e&&void 0!==e.opacity&&0!==this.alphaKeys.length)if(t<=this.alphaKeys[0].frame)e.opacity=this.alphaKeys[0].alpha;else if(t>=this.alphaKeys[this.alphaKeys.length-1].frame)e.opacity=this.alphaKeys[this.alphaKeys.length-1].alpha;else{for(var i=0;this.alphaKeys[i].frame<t;)i++;var s,o=this.alphaKeys[i-1],a=this.alphaKeys[i];"step"==a.interpolation?e.opacity=(t==a.frame?a:o).alpha:(s=(t-o.frame)/(a.frame-o.frame),e.opacity=o.alpha*(1-s)+a.alpha*s)}},CAnimation.prototype.setVertexCoordinatesForFrame=function(e,t){if(void 0!==t&&void 0!==e&&0!==this.verticesPositionKeys.length){var i,s,o=0;if(t<=this.verticesPositionKeys[0].frame)i=s=this.verticesPositionKeys[0].name;else if(t>=this.verticesPositionKeys[this.verticesPositionKeys.length-1].frame)i=s=this.verticesPositionKeys[this.verticesPositionKeys.length-1].name;else{for(var a=0;this.verticesPositionKeys[a].frame<t;)a++;var r=this.verticesPositionKeys[a-1],n=this.verticesPositionKeys[a];"step"==n.interpolation?i=s=(t==n.frame?n:r).name:(o=(t-r.frame)/(n.frame-r.frame),i=r.name,s=n.name)}for(var l=0;l<e.objectParts.length;++l){var y=e.objectParts[l];y.vertexCoordinates.id=y.vertexAnimationPartsByName[i],y.vertexCoordinates2.id=y.vertexAnimationPartsByName[s],y.vertexCoordinatesAnimationParameter=o}}},CAnimation.prototype.setVertexColorsForFrame=function(e,t){if(void 0!==t&&void 0!==e&&0!==this.verticesColorKeys.length){var i,s,o=0;if(t<=this.verticesColorKeys[0].frame)i=s=this.verticesColorKeys[0].name;else if(t>=this.verticesColorKeys[this.verticesColorKeys.length-1].frame)i=s=this.verticesColorKeys[this.verticesColorKeys.length-1].name;else{for(var a=0;this.verticesColorKeys[a].frame<t;)a++;var r=this.verticesColorKeys[a-1],n=this.verticesColorKeys[a];"step"==n.interpolation?i=s=(t==n.frame?n:r).name:(o=(t-r.frame)/(n.frame-r.frame),i=r.name,s=n.name)}e.useTexture=!0;for(var l=0;l<e.objectParts.length;++l){var y=e.objectParts[l];y.vertexColors.id=y.vertexAnimationPartsByName[i],y.vertexColors2.id=y.vertexAnimationPartsByName[s],y.vertexColorsAnimationParameter=o}}},CAnimationPlayback.prototype.empty=function(){return 0===this.keys.length},CAnimationPlayback.prototype.addKey=function(e,t,i,s,o){i=replaceAll(i,"\n","<br/>");this.keys.push({frame:e,pause:t,name:i,color:s,moves:o})},CAnimationPlayback.prototype.getKeyCount=function(){return this.keys.length},CAnimationPlayback.prototype.getKey=function(e){return this.keys[e]},CAnimationPlayback.prototype.getFirstKey=function(){return this.keys[0]},CAnimationPlayback.prototype.getLastKey=function(){return this.keys[this.keys.length-1]};